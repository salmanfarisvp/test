{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { build, BuildOptions, Loader, Plugin } from 'esbuild'\nimport { extname, dirname, sep } from 'path'\nimport { readFile } from 'fs/promises'\nimport { basename, parse } from 'path'\nimport { green, red, yellow, white } from 'kleur/colors'\nimport { gzipSize } from 'gzip-size'\nimport brotliSizeModule from 'brotli-size'\nimport prettyBytes from 'pretty-bytes'\nimport fastGlob from 'fast-glob'\nimport { writeFileSync } from 'fs'\nimport { generateDtsBundle, LibrariesOptions, OutputOptions } from 'dts-bundle-generator'\nimport { debug, error, info, log, time, timeEnd, warn } from '@jsheaven/status-message'\n\n/** adds spaces from left so that all lines are visually in line vertically */\nexport const getPadLeft = (str: string, width: number, char = ' ') => char.repeat(width - str.length)\n\n/** formats the byte/kByte sizes with coloring */\nexport const formatSize = (size: number, filename: string, type?: string, raw?: boolean) => {\n  const pretty = raw ? `${size} B` : prettyBytes(size)\n  const color = size < 5000 ? green : size > 40000 ? red : yellow\n  const indent = getPadLeft(pretty, 13)\n  return `${indent}${color(pretty)}: ${white(basename(filename))}${type ? `.${type}` : ''}`\n}\n\n/** returns the text of all file sizes per compression */\nexport const getSizeInfo = async (code: string, filename: string, raw: boolean) => {\n  raw = raw || code.length < 5000\n\n  const [gzip, brotli] = await Promise.all([\n    gzipSize(code).catch(() => null),\n    // @ts-ignore\n    brotliSizeModule.default(code).catch(() => null),\n  ])\n\n  let out = formatSize(gzip, filename, 'gz', raw)\n  if (brotli) {\n    out += '\\n' + formatSize(brotli, filename, 'br', raw)\n  }\n  return out\n}\n\n/** adds all node_module imports to external so that --bundle in esbuild is not bundling them in */\nexport const makeAllPackagesExternalPlugin: Plugin = {\n  name: 'make-all-packages-external',\n  setup(build) {\n    let filter = /^[^.\\/]|^\\.[^.\\/]|^\\.\\.[^\\/]/ // Must not start with \"/\" or \"./\" or \"../\"\n    build.onResolve({ filter }, (args) => ({ path: args.path, external: true }))\n  },\n}\n\n/** makes sure that all \"/Users/admin/Code/easybundle/src\" and \"/Users/admin/Code/easybundle/src/index.ts\" occurances are replaced why the actual filenames */\nexport const esmDirnamePlugin: Plugin = {\n  name: 'esmDirname',\n  setup(build) {\n    const nodeModules = new RegExp(/^(?:.*[\\\\\\/])?node_modules(?:[\\\\\\/].*)?$/)\n    build.onLoad({ filter: /.*/ }, async ({ path }) => {\n      if (!path.match(nodeModules)) {\n        let contents = await readFile(path, 'utf8')\n        const loader = extname(path).substring(1) as Loader\n        const _dirname = dirname(path)\n        contents = contents.replaceAll('\"/Users/admin/Code/easybundle/src\"', `\"${_dirname}\"`).replaceAll('\"/Users/admin/Code/easybundle/src/index.ts\"', `\"${path}\"`)\n        return {\n          contents,\n          loader,\n        }\n      }\n    })\n  },\n}\n\n/** default baseConfig for esbuild */\nexport const baseConfig: BuildOptions = {\n  sourcemap: 'linked',\n  target: 'esnext',\n  bundle: true,\n  minify: true,\n  minifySyntax: true,\n  minifyIdentifiers: true,\n  minifyWhitespace: true,\n  legalComments: 'none',\n}\n\n/** prints all file sizes for the generated JS files */\nconst printFileSizes = async (outfile: string) => {\n  const outfileParsed = parse(outfile)\n  log('OK', 'Find your bundle in', outfileParsed.dir)\n  const file = await fastGlob(`${outfileParsed.dir}${sep}${outfileParsed.name}*{js,map,d.ts}`)\n\n  for (let i = 0; i < file.length; i++) {\n    const filePath = file[i]\n    const code = await readFile(filePath, { encoding: 'utf8' })\n    if (filePath.endsWith('.js')) {\n      console.log(await getSizeInfo(code, filePath, false))\n    }\n    console.log(formatSize(Buffer.from(code).byteLength, filePath))\n  }\n}\n\n/** rewrites the outfile name from e.g. ./dist/index.js to ./dist/index.esm.js, ./dist/index.iife.js */\nexport const getOutfileName = (fileName: string, subType: BuildOptions['format']) => {\n  const fileNameParsed = parse(fileName)\n  return `${fileNameParsed.dir}${sep}${fileNameParsed.name}.${subType}${fileNameParsed.ext}`\n}\n\n/** options applied, when debug is enabled */\nexport const debugBuildOptions: Partial<BuildOptions> = {\n  minify: false,\n  minifySyntax: false,\n  minifyIdentifiers: false,\n  minifyWhitespace: false,\n}\n\n/** calls esbuild with a dynamic configuration per format */\nexport const genericBuild = async ({\n  outputFormats,\n  entryPoint,\n  outfile,\n  esBuildOptions,\n  debug: isDebug,\n  dts,\n  tsConfigPath,\n  dtsLibOptions,\n  dtsOutputOptions,\n}: BundleConfig) => {\n  time('BUNDLED IN')\n\n  if (isDebug) {\n    // override minification parameters\n    // but let the user still influence them\n    esBuildOptions = {\n      ...esBuildOptions,\n      ...debugBuildOptions,\n    } as BuildOptions\n\n    debug(\n      'CONFIG',\n      'easybundle',\n      {\n        entryPoint,\n        outfile,\n        esBuildOptions,\n        debug: isDebug,\n        dts,\n        tsConfigPath,\n        dtsLibOptions,\n        dtsOutputOptions,\n      },\n      'esbuild plugins',\n      esBuildOptions.plugins,\n    )\n  }\n\n  time('BUILT IN')\n  info('BUILD', 'Transpiling', entryPoint, '...')\n\n  await Promise.all(\n    outputFormats.map(async (format: BuildOptions['format']) =>\n      build({\n        format,\n        entryPoints: [entryPoint],\n        outfile: getOutfileName(outfile, format),\n        ...(esBuildOptions || {}),\n      } as BuildOptions),\n    ),\n  )\n  timeEnd('BUILT IN')\n\n  if (dts) {\n    time('DTS IN')\n    info('DTS', 'Generating .d.ts files...')\n    try {\n      const dTsBundles = generateDtsBundle(\n        [\n          {\n            filePath: entryPoint,\n            libraries: dtsLibOptions,\n            output: dtsOutputOptions,\n          },\n        ],\n        { preferredConfigPath: tsConfigPath },\n      )\n\n      for (let i = 0; i < outputFormats.length; i++) {\n        const format = outputFormats[i]\n        const outFileNameParsed = parse(getOutfileName(outfile, format))\n        const declarationOutFile = `${outFileNameParsed.dir}${sep}${outFileNameParsed.name}.d.ts`\n        writeFileSync(declarationOutFile, dTsBundles[0], { encoding: 'utf-8' })\n      }\n    } catch (e) {\n      if (/Symbol for root source file (.*) not found/.test(e.toString())) {\n        warn('DTS', 'No type exports found. Skipping.')\n      } else {\n        error('DTS', 'Error while generating .d.ts files: ', e)\n      }\n    }\n    timeEnd('DTS IN')\n  }\n  await printFileSizes(outfile)\n\n  timeEnd('BUNDLED IN')\n}\n\nexport interface BundleConfig {\n  /** allows to customize the output formats that esbuild would generate. default: ['iife', 'esm', 'cjs'] */\n  outputFormats?: Array<BuildOptions['format']>\n\n  /** shall the output not be minified and treeShaked but left readable?  default: false */\n  debug?: boolean\n\n  /** a file to start bundling for. e.g. ./src/index.ts */\n  entryPoint: string\n\n  /** a file to write to. e.g. ./dist/index.js */\n  outfile: string\n\n  /** shall the output include .d.ts type declarations? (takes much longer to compile); default: true */\n  dts?: boolean\n\n  /** allows to inline types of libraries etc. */\n  dtsLibOptions?: LibrariesOptions\n\n  /** allows to control .d.ts. bundle specifics */\n  dtsOutputOptions?: OutputOptions\n\n  /** path to a tsconfig.json file, if existing; default: 'tsconfig.json' */\n  tsConfigPath?: string\n\n  /** esbuild BuildConfig to override internal configuration */\n  esBuildOptions?: BuildOptions\n}\n\nexport const genericDefaultBundleConifg: Partial<BundleConfig> = {\n  outputFormats: ['iife', 'esm', 'cjs'],\n  dts: true,\n  tsConfigPath: 'tsconfig.json',\n  dtsOutputOptions: {\n    exportReferencedTypes: true,\n    inlineDeclareExternals: true,\n    inlineDeclareGlobals: true,\n    noBanner: true,\n    sortNodes: true,\n  },\n}\n\nexport const defaultBundleConfigBrowser: Partial<BundleConfig> = {\n  ...genericDefaultBundleConifg,\n  esBuildOptions: {\n    ...baseConfig,\n    platform: 'browser',\n    plugins: [esmDirnamePlugin],\n  },\n}\n\nexport const defaultBundleConfigNode: Partial<BundleConfig> = {\n  ...genericDefaultBundleConifg,\n  esBuildOptions: {\n    ...baseConfig,\n    platform: 'node',\n    plugins: [esmDirnamePlugin, makeAllPackagesExternalPlugin],\n  },\n}\n\n/** configures esbuild to build one file for a browser environment; defaults: defaultBundleConfigBrowser  */\nexport const buildForBrowser = async (config: BundleConfig) =>\n  genericBuild({\n    ...defaultBundleConfigBrowser,\n    ...config,\n    dtsOutputOptions: {\n      ...defaultBundleConfigBrowser.dtsOutputOptions,\n      ...(config.dtsOutputOptions || {}),\n    },\n    esBuildOptions: {\n      ...defaultBundleConfigBrowser.esBuildOptions,\n      ...(config.esBuildOptions || {}),\n    },\n  })\n\n/** configures esbuild to build one file for a Node.js environment; defaults: defaultBundleConfigNode */\nexport const buildForNode = async (config: BundleConfig) =>\n  genericBuild({\n    ...defaultBundleConfigNode,\n    ...config,\n    dtsOutputOptions: {\n      ...defaultBundleConfigNode.dtsOutputOptions,\n      ...(config.dtsOutputOptions || {}),\n    },\n    esBuildOptions: {\n      ...defaultBundleConfigNode.esBuildOptions,\n      ...(config.esBuildOptions || {}),\n    },\n  })\n"],
  "mappings": "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",
  "names": ["build"]
}
