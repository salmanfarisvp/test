{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import { build, BuildOptions, Loader, Plugin } from 'esbuild'\nimport { extname, dirname, sep } from 'path'\nimport { readFile } from 'fs/promises'\nimport { basename, parse } from 'path'\nimport { green, red, yellow, white } from 'kleur/colors'\nimport { gzipSize } from 'gzip-size'\nimport brotliSizeModule from 'brotli-size'\nimport prettyBytes from 'pretty-bytes'\nimport fastGlob from 'fast-glob'\nimport { writeFileSync } from 'fs'\nimport { generateDtsBundle, LibrariesOptions, OutputOptions } from 'dts-bundle-generator'\nimport { debug, error, info, log, time, timeEnd, warn } from '@jsheaven/status-message'\n\n/** adds spaces from left so that all lines are visually in line vertically */\nexport const getPadLeft = (str: string, width: number, char = ' ') => char.repeat(width - str.length)\n\n/** formats the byte/kByte sizes with coloring */\nexport const formatSize = (size: number, filename: string, type?: string, raw?: boolean) => {\n  const pretty = raw ? `${size} B` : prettyBytes(size)\n  const color = size < 5000 ? green : size > 40000 ? red : yellow\n  const indent = getPadLeft(pretty, 13)\n  return `${indent}${color(pretty)}: ${white(basename(filename))}${type ? `.${type}` : ''}`\n}\n\n/** returns the text of all file sizes per compression */\nexport const getSizeInfo = async (code: string, filename: string, raw: boolean) => {\n  raw = raw || code.length < 5000\n\n  const [gzip, brotli] = await Promise.all([\n    gzipSize(code).catch(() => null),\n    // @ts-ignore\n    brotliSizeModule.default(code).catch(() => null),\n  ])\n\n  let out = formatSize(gzip, filename, 'gz', raw)\n  if (brotli) {\n    out += '\\n' + formatSize(brotli, filename, 'br', raw)\n  }\n  return out\n}\n\n/** adds all node_module imports to external so that --bundle in esbuild is not bundling them in */\nexport const makeAllPackagesExternalPlugin: Plugin = {\n  name: 'make-all-packages-external',\n  setup(build) {\n    let filter = /^[^.\\/]|^\\.[^.\\/]|^\\.\\.[^\\/]/ // Must not start with \"/\" or \"./\" or \"../\"\n    build.onResolve({ filter }, (args) => ({ path: args.path, external: true }))\n  },\n}\n\n/** makes sure that all \"/Users/admin/Code/easybundle/src\" and \"/Users/admin/Code/easybundle/src/index.ts\" occurances are replaced why the actual filenames */\nexport const esmDirnamePlugin: Plugin = {\n  name: 'esmDirname',\n  setup(build) {\n    const nodeModules = new RegExp(/^(?:.*[\\\\\\/])?node_modules(?:[\\\\\\/].*)?$/)\n    build.onLoad({ filter: /.*/ }, async ({ path }) => {\n      if (!path.match(nodeModules)) {\n        let contents = await readFile(path, 'utf8')\n        const loader = extname(path).substring(1) as Loader\n        const _dirname = dirname(path)\n        contents = contents.replaceAll('\"/Users/admin/Code/easybundle/src\"', `\"${_dirname}\"`).replaceAll('\"/Users/admin/Code/easybundle/src/index.ts\"', `\"${path}\"`)\n        return {\n          contents,\n          loader,\n        }\n      }\n    })\n  },\n}\n\n/** default baseConfig for esbuild */\nexport const baseConfig: BuildOptions = {\n  sourcemap: 'linked',\n  target: 'esnext',\n  bundle: true,\n  minify: true,\n  minifySyntax: true,\n  minifyIdentifiers: true,\n  minifyWhitespace: true,\n  legalComments: 'none',\n}\n\n/** prints all file sizes for the generated JS files */\nconst printFileSizes = async (outfile: string) => {\n  const outfileParsed = parse(outfile)\n  log('OK', 'Find your bundle in', outfileParsed.dir)\n  const file = await fastGlob(`${outfileParsed.dir}${sep}${outfileParsed.name}*{js,map,d.ts}`)\n\n  for (let i = 0; i < file.length; i++) {\n    const filePath = file[i]\n    const code = await readFile(filePath, { encoding: 'utf8' })\n    if (filePath.endsWith('.js')) {\n      console.log(await getSizeInfo(code, filePath, false))\n    }\n    console.log(formatSize(Buffer.from(code).byteLength, filePath))\n  }\n}\n\n/** rewrites the outfile name from e.g. ./dist/index.js to ./dist/index.esm.js, ./dist/index.iife.js */\nexport const getOutfileName = (fileName: string, subType: BuildOptions['format']) => {\n  const fileNameParsed = parse(fileName)\n  return `${fileNameParsed.dir}${sep}${fileNameParsed.name}.${subType}${fileNameParsed.ext}`\n}\n\n/** options applied, when debug is enabled */\nexport const debugBuildOptions: Partial<BuildOptions> = {\n  minify: false,\n  minifySyntax: false,\n  minifyIdentifiers: false,\n  minifyWhitespace: false,\n}\n\n/** calls esbuild with a dynamic configuration per format */\nexport const genericBuild = async ({\n  outputFormats,\n  entryPoint,\n  outfile,\n  esBuildOptions,\n  debug: isDebug,\n  dts,\n  tsConfigPath,\n  dtsLibOptions,\n  dtsOutputOptions,\n}: BundleConfig) => {\n  time('BUNDLED IN')\n\n  if (isDebug) {\n    // override minification parameters\n    // but let the user still influence them\n    esBuildOptions = {\n      ...esBuildOptions,\n      ...debugBuildOptions,\n    } as BuildOptions\n\n    debug(\n      'CONFIG',\n      'easybundle',\n      {\n        entryPoint,\n        outfile,\n        esBuildOptions,\n        debug: isDebug,\n        dts,\n        tsConfigPath,\n        dtsLibOptions,\n        dtsOutputOptions,\n      },\n      'esbuild plugins',\n      esBuildOptions.plugins,\n    )\n  }\n\n  time('BUILT IN')\n  info('BUILD', 'Transpiling', entryPoint, '...')\n\n  await Promise.all(\n    outputFormats.map(async (format: BuildOptions['format']) =>\n      build({\n        format,\n        entryPoints: [entryPoint],\n        outfile: getOutfileName(outfile, format),\n        ...(esBuildOptions || {}),\n      } as BuildOptions),\n    ),\n  )\n  timeEnd('BUILT IN')\n\n  if (dts) {\n    time('DTS IN')\n    info('DTS', 'Generating .d.ts files...')\n    try {\n      const dTsBundles = generateDtsBundle(\n        [\n          {\n            filePath: entryPoint,\n            libraries: dtsLibOptions,\n            output: dtsOutputOptions,\n          },\n        ],\n        { preferredConfigPath: tsConfigPath },\n      )\n\n      for (let i = 0; i < outputFormats.length; i++) {\n        const format = outputFormats[i]\n        const outFileNameParsed = parse(getOutfileName(outfile, format))\n        const declarationOutFile = `${outFileNameParsed.dir}${sep}${outFileNameParsed.name}.d.ts`\n        writeFileSync(declarationOutFile, dTsBundles[0], { encoding: 'utf-8' })\n      }\n    } catch (e) {\n      if (/Symbol for root source file (.*) not found/.test(e.toString())) {\n        warn('DTS', 'No type exports found. Skipping.')\n      } else {\n        error('DTS', 'Error while generating .d.ts files: ', e)\n      }\n    }\n    timeEnd('DTS IN')\n  }\n  await printFileSizes(outfile)\n\n  timeEnd('BUNDLED IN')\n}\n\nexport interface BundleConfig {\n  /** allows to customize the output formats that esbuild would generate. default: ['iife', 'esm', 'cjs'] */\n  outputFormats?: Array<BuildOptions['format']>\n\n  /** shall the output not be minified and treeShaked but left readable?  default: false */\n  debug?: boolean\n\n  /** a file to start bundling for. e.g. ./src/index.ts */\n  entryPoint: string\n\n  /** a file to write to. e.g. ./dist/index.js */\n  outfile: string\n\n  /** shall the output include .d.ts type declarations? (takes much longer to compile); default: true */\n  dts?: boolean\n\n  /** allows to inline types of libraries etc. */\n  dtsLibOptions?: LibrariesOptions\n\n  /** allows to control .d.ts. bundle specifics */\n  dtsOutputOptions?: OutputOptions\n\n  /** path to a tsconfig.json file, if existing; default: 'tsconfig.json' */\n  tsConfigPath?: string\n\n  /** esbuild BuildConfig to override internal configuration */\n  esBuildOptions?: BuildOptions\n}\n\nexport const genericDefaultBundleConifg: Partial<BundleConfig> = {\n  outputFormats: ['iife', 'esm', 'cjs'],\n  dts: true,\n  tsConfigPath: 'tsconfig.json',\n  dtsOutputOptions: {\n    exportReferencedTypes: true,\n    inlineDeclareExternals: true,\n    inlineDeclareGlobals: true,\n    noBanner: true,\n    sortNodes: true,\n  },\n}\n\nexport const defaultBundleConfigBrowser: Partial<BundleConfig> = {\n  ...genericDefaultBundleConifg,\n  esBuildOptions: {\n    ...baseConfig,\n    platform: 'browser',\n    plugins: [esmDirnamePlugin],\n  },\n}\n\nexport const defaultBundleConfigNode: Partial<BundleConfig> = {\n  ...genericDefaultBundleConifg,\n  esBuildOptions: {\n    ...baseConfig,\n    platform: 'node',\n    plugins: [esmDirnamePlugin, makeAllPackagesExternalPlugin],\n  },\n}\n\n/** configures esbuild to build one file for a browser environment; defaults: defaultBundleConfigBrowser  */\nexport const buildForBrowser = async (config: BundleConfig) =>\n  genericBuild({\n    ...defaultBundleConfigBrowser,\n    ...config,\n    dtsOutputOptions: {\n      ...defaultBundleConfigBrowser.dtsOutputOptions,\n      ...(config.dtsOutputOptions || {}),\n    },\n    esBuildOptions: {\n      ...defaultBundleConfigBrowser.esBuildOptions,\n      ...(config.esBuildOptions || {}),\n    },\n  })\n\n/** configures esbuild to build one file for a Node.js environment; defaults: defaultBundleConfigNode */\nexport const buildForNode = async (config: BundleConfig) =>\n  genericBuild({\n    ...defaultBundleConfigNode,\n    ...config,\n    dtsOutputOptions: {\n      ...defaultBundleConfigNode.dtsOutputOptions,\n      ...(config.dtsOutputOptions || {}),\n    },\n    esBuildOptions: {\n      ...defaultBundleConfigNode.esBuildOptions,\n      ...(config.esBuildOptions || {}),\n    },\n  })\n"],
  "mappings": "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",
  "names": ["import_path", "prettyBytes", "brotliSizeModule", "build", "fastGlob"]
}
